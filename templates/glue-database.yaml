AWSTemplateFormatVersion: '2010-09-09'
Description: Glue database and tables

Parameters:
  StudyName:
    Type: String
    Description: Study name, used to determine database name and S3 keyprefix

  BucketName:
    Type: String
    Description: Name of the S3 bucket storing the datasets

  JsonPrefix:
    Type: String
    Description: Prefix of the object keys
    Default: raw_json

Resources:

  GlueDatabase:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: !Sub '${StudyName}-db'

  AnswersTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_answers
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: distractions
              Type: boolean
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=answers/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: day,distractions,month,recordId,taskIdentifier,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  InfoTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_info
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: format
              Type: string
            - Name: appversion
              Type: string
            - Name: appname
              Type: string
            - Name: datafilename
              Type: string
            - Name: schemarevision
              Type: int
            - Name: phoneinfo
              Type: string
            - Name: files
              Type: array<struct<contentType:string,filename:string,timestamp:string>>
            - Name: item
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=info/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: appName,appVersion,dataFilename,day,files,format,item,month,phoneInfo,recordId,schemaRevision,taskIdentifier,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          SortColumns: []
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  MetadataTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_metadata
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: deviceinfo
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: enddate
              Type: string
            - Name: devicetypeidentifier
              Type: string
            - Name: startdate
              Type: string
            - Name: rsdframeworkversion
              Type: string
            - Name: datagroups
              Type: string
            - Name: files
              Type: array<struct<filename:string,timestamp:string,contentType:string,identifier:string,stepPath:string>>
            - Name: appname
              Type: string
            - Name: appversion
              Type: string
            - Name: taskrunuuid
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
            - Name: substudymemberships
              Type: string
            - Name: healthcode
              Type: string
            - Name: createdon
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=metadata/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: appName,appVersion,createdon,dataGroups,day,deviceInfo,deviceTypeIdentifier,endDate,files,healthcode,month,recordId,rsdFrameworkVersion,startDate,substudymemberships,taskIdentifier,taskRunUUID,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  MicrophoneLevelsTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_microphone_levels
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          jsonPath: $[*]
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: uptime
              Type: double
            - Name: unit
              Type: string
            - Name: peak
              Type: double
            - Name: average
              Type: double
            - Name: steppath
              Type: string
            - Name: timeinterval
              Type: int
            - Name: timestamp
              Type: double
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=microphone_levels/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            jsonPath: $[*]
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: average,day,month,peak,recordId,stepPath,taskIdentifier,timeInterval,timestamp,unit,uptime,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  MotionTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_motion
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          jsonPath: $[*]
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: uptime
              Type: double
            - Name: timestamp
              Type: double
            - Name: timestampdate
              Type: string
            - Name: steppath
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
            - Name: x
              Type: double
            - Name: y
              Type: double
            - Name: sensortype
              Type: string
            - Name: z
              Type: double
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=motion/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            jsonPath: $[*]
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: day,month,recordId,sensorType,stepPath,taskIdentifier,timestamp,timestampDate,uptime,x,y,year,z
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  TaskDataTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_taskdata
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: fnmscore
              Type: int
            - Name: fnlscore
              Type: int
            - Name: testversion
              Type: string
            - Name: stephistory
              Type: >-
                array<struct<interactions:array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>,startDate:string,endDate:string,identifier:string,practice:boolean,type:string,wasInterrupted:boolean,score:int,section:string,response:int,responseTime:int>>
            - Name: locale
              Type: string
            - Name: enddate
              Type: string
            - Name: fsbscore
              Type: int
            - Name: taskstatus
              Type: string
            - Name: startdate
              Type: string
            - Name: taskname
              Type: string
            - Name: userinteractions
              Type: array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>
            - Name: rawscore
              Type: int
            - Name: steps
              Type: >-
                array<struct<position:int,endDate:string,interactions:array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>,startDate:string,identifier:string,practice:boolean,type:string,wasInterrupted:boolean,section:string,response:int,score:int,responseTime:int>>
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=taskdata/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: accuracy,administeredSteps,consideredSteps,day,endDate,finalSE,finalTheta,itemCount,locale,month,nAnticipationLive,nAnticipationPractice,rateScore,rawScore,recordId,startDate,startSE,startTheta,stepHistory,steps,taskIdentifier,taskName,taskStatus,testVersion,totalErrors,userInteractions,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  TaskResultTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_taskresult
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: asyncresults
              Type: array<struct<weather:struct<clouds:int,humidity:int,provider:string,startDate:string,wind:struct<speed:double,degrees:int,gust:double>,seaLevelPressure:int,temperature:double,identifier:string,type:string>,startDate:string,type:string,identifier:string,endDate:string,contentType:string,startUptime:double,relativePath:string>>
            - Name: schemainfo
              Type: struct<revision:int,identifier:string>
            - Name: enddate
              Type: string
            - Name: startdate
              Type: string
            - Name: stephistory
              Type: array<struct<asyncResults:array<struct<fnmScore:int,fnlScore:int,testVersion:string,stepHistory:array<struct<interactions:array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>,startDate:string,endDate:string,identifier:string,practice:boolean,type:string,wasInterrupted:boolean,score:int,section:string,response:int,responseTime:int>>,locale:string,endDate:string,fsbScore:int,taskStatus:string,startDate:string,taskName:string,userInteractions:array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>,rawScore:int,steps:array<struct<position:int,endDate:string,interactions:array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>,startDate:string,identifier:string,practice:boolean,type:string,wasInterrupted:boolean,section:string,response:int,score:int,responseTime:int>>>>,schemaInfo:struct<revision:int,identifier:string>,endDate:string,startDate:string,stepHistory:array<struct<interactions:array<struct<stepIdentifier:string,timestamp:string,identifier:string,controlEvent:string,value:string>>,startDate:string,endDate:string,identifier:string,practice:boolean,type:string,wasInterrupted:boolean,score:int,section:string,response:int,responseTime:int>>,taskRunUUID:string,identifier:string,type:string,nodePath:array<string>,assessmentIdentifier:string,schemaIdentifier:string,answerType:struct<type:string>,value:boolean,questionText:string>>
            - Name: taskrunuuid
              Type: string
            - Name: identifier
              Type: string
            - Name: type
              Type: string
            - Name: nodepath
              Type: array<string>
            - Name: assessmentidentifier
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=taskresult/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: assessmentIdentifier,asyncResults,day,endDate,identifier,month,nodePath,recordId,schemaInfo,startDate,stepHistory,taskIdentifier,taskRunUUID,type,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

  WeatherTable:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Name: dataset_weather
        Parameters:
          CrawlerSchemaDeserializerVersion: '1.0'
          CrawlerSchemaSerializerVersion: '1.0'
          classification: json
          compressionType: none
          typeOfData: file
        PartitionKeys:
          - Name: taskidentifier
            Type: string
          - Name: year
            Type: string
          - Name: month
            Type: string
          - Name: day
            Type: string
          - Name: recordid
            Type: string
        Retention: 0
        StorageDescriptor:
          Columns:
            - Name: weather
              Type: struct<clouds:int,humidity:int,provider:string,startDate:string,wind:struct<speed:double,degrees:int,gust:double>,seaLevelPressure:int,temperature:double,identifier:string,type:string>
            - Name: startdate
              Type: string
            - Name: type
              Type: string
            - Name: identifier
              Type: string
            - Name: enddate
              Type: string
            - Name: taskidentifier
              Type: string
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
            - Name: recordid
              Type: string
          Compressed: false
          InputFormat: org.apache.hadoop.mapred.TextInputFormat
          Location: !Sub s3://${BucketName}/${StudyName}/${JsonPrefix}/dataset=weather/
          OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
          Parameters:
            CrawlerSchemaDeserializerVersion: '1.0'
            CrawlerSchemaSerializerVersion: '1.0'
            classification: json
            compressionType: none
            typeOfData: file
          SerdeInfo:
            Parameters:
              paths: airQuality,day,endDate,identifier,month,recordId,startDate,taskIdentifier,type,weather,year
            SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

Outputs:

  DatabaseName:
    Value: !Ref GlueDatabase
    Export:
      Name: !Sub '${AWS::Region}-${AWS::StackName}-DatabaseName'
